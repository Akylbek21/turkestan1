<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Traveler Passport — Turkestan Guide</title>
  <link rel="stylesheet" href="css/main.css"/>

  <!-- Force default language to EN (if your i18n.js is connected elsewhere) -->
  <script>try{localStorage.setItem('lang','en');}catch(e){}</script>

  <style>
    /* Passport UI — tuned to Sunset Glass v2 tokens in main.css */
    .passport-wrap{max-width:980px;margin:22px auto;padding:0 16px}
    .pass-card{
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(var(--blur));
      transition: transform var(--dur-fast,var(--dur)) var(--easing,.28s), box-shadow var(--dur-fast,var(--dur)) var(--easing,.28s);
    }
    .pass-card:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .pass-header{display:grid;gap:12px;grid-template-columns:1fr;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:grid;gap:6px;min-width:240px;flex:1}
    .field input{
      all:unset;background:var(--surface-2);border:1px solid var(--border);
      border-radius:12px;padding:10px 12px; box-shadow: var(--shadow-sm);
    }
    .stats{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--border);overflow:hidden;flex:1;min-width:200px}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--grad1),var(--grad3));width:0%}
    .badge-lg{
      font-weight:700;padding:6px 10px;border-radius:999px;
      background: linear-gradient(90deg,var(--grad1),var(--grad3));color:#2e1400;box-shadow: var(--shadow-sm)
    }
    .achievements{display:flex;gap:8px;flex-wrap:wrap}
    .ach{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2)}
    .ach.on{border-color:#fff; box-shadow:0 0 0 2px rgba(255,255,255,.18) inset}

    .grid-stamps{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .stamp{
      position:relative;border:1px dashed rgba(255,255,255,.28);border-radius:14px;padding:12px;background:rgba(0,0,0,.30);
      min-height:170px;display:flex;flex-direction:column;gap:8px;justify-content:space-between;overflow:hidden;
      transition:transform .18s var(--easing), box-shadow .18s var(--easing), border-color .18s var(--easing);
    }
    .stamp:hover{ transform: translateY(-2px); box-shadow: var(--shadow-sm); border-color: var(--border); }
    .stamp .title{font-weight:600;padding-right:96px} /* room for thumb */
    .stamp .loc{color:var(--muted);font-size:12px}
    .stamp .date{font-size:12px;color:#d1fae5}
    .stamp .status{font-size:12px;color:var(--muted)}
    .stamp.visited{
      border-style:solid;border-color:rgba(255,255,255,.5);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    }
    .stamp .emblem{
      position:absolute;right:-22px;top:-22px;width:120px;height:120px;border-radius:50%;
      border:3px solid rgba(255,255,255,.38);transform:rotate(-15deg);opacity:.20
    }

    /* Thumbnails */
    .stamp{ padding-top:58px }
    .stamp .thumb{
      position:absolute; right:12px; top:12px;
      width:84px; height:54px; object-fit:cover; border-radius:10px;
      box-shadow:0 8px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.18);
      opacity:.96; transition:transform .25s ease, opacity .25s ease;
      background:#0b1530;
    }
    .stamp:hover .thumb{ transform:translateY(-2px) scale(1.02); opacity:1 }

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .btn{all:unset;cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);box-shadow:var(--shadow-sm)}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
    .btn.primary{background:linear-gradient(90deg,var(--grad1),var(--grad3));color:#2e1400;border:none}
    .btn.warn{border:1px solid #7f1d1d;background:#1b0d0d;color:#fecaca}

    .timeline{display:grid;gap:8px}
    .tl-item{border-left:3px solid rgba(255,255,255,.6);padding:8px 12px;background:rgba(0,0,0,.30);border-radius:8px}

    .muted{color:var(--muted)}

    @media (max-width:560px){
      .stamp{ padding-top:46px }
      .stamp .thumb{ width:70px; height:46px }
    }
    @media print{
      header, .controls{display:none!important}
      body{background:#fff}
      .passport-wrap{max-width:100%;margin:0;padding:0}
      .pass-card{box-shadow:none;border-color:#999}
      .stamp{break-inside:avoid}
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;gap:12px;align-items:center">
      <a href="index.html" class="badge" style="text-decoration:none">← Home</a>
      <h1 style="margin:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));-webkit-background-clip:text;background-clip:text;color:transparent">
        Traveler Passport
      </h1>
      <span id="visited-badge" class="badge" style="margin-left:auto">Visited: 0 / 27</span>
    </div>
  </header>

  <main class="passport-wrap">
    <!-- Profile + progress -->
    <section class="pass-card">
      <div class="pass-header">
        <div class="row">
          <div class="field">
            <label class="loc">Traveler name</label>
            <input id="p-name" placeholder="e.g., Aruzhan or Yermek"/>
          </div>
          <div class="field">
            <label class="loc">Class / group (optional)</label>
            <input id="p-class" placeholder="School No. …, Grade 7A"/>
          </div>
        </div>

        <div class="stats">
          <div class="badge-lg" id="level">Level: Newcomer</div>
          <div class="progress"><span id="pr-bar"></span></div>
          <div class="loc" id="pr-text">0 of 27 places</div>
        </div>

        <div class="achievements" id="ach-wrap">
          <div class="ach" id="ach-5">Bronze · 5 places</div>
          <div class="ach" id="ach-12">Silver · 12 places</div>
          <div class="ach" id="ach-20">Gold · 20 places</div>
          <div class="ach" id="ach-27">Master · 27 places</div>
        </div>

        <div class="controls">
          <button class="btn" id="btn-print">Print / PDF</button>
          <button class="btn" id="btn-export">Export JSON</button>
          <button class="btn" id="btn-import">Import JSON</button>
          <button class="btn warn" id="btn-reset">Reset progress</button>
        </div>
      </div>
    </section>

    <!-- Stamps -->
    <section class="pass-card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Visit stamps</h3>
      <div class="grid-stamps" id="stamps"></div>
    </section>

    <!-- Timeline -->
    <section class="pass-card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Travel timeline</h3>
      <div class="timeline" id="timeline">
        <div class="muted">Empty for now — mark any place with the “I was here” button on its page.</div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">© <span id="y"></span> Turkestan Guide — Traveler Passport</div>
  </footer>

  <script>
  /* ===== Data: 27 places (EN) ===== */
  const PLACES = [
    { id:'mailikozha-homeland',   title:'Homeland of Poet Mailikozha',      location:'Arys district' },
    { id:'murynkarak-seven-mounds', title:'“Seven Burial Mounds” of Murynkarak', location:'Arys district' },
    { id:'munlyq-zarliq-mausoleum', title:'Mausoleum of Munlyq and Zarliq', location:'near Zhideli & Akdala' },
    { id:'bairkumtobe',            title:'Bairkumtobe Ancient Settlement',  location:'left bank of Syr Darya' },
    { id:'zheken-shayyk',          title:'Zheken Shayyk Saint',             location:'Arys district' },
    { id:'arys-station',       title:'Arys-1 Railway Station',               location:'Arys city' },
    { id:'otrar',              title:'Otrar Settlement (Otyrartobe)',        location:'Shaulder village' },
    { id:'kuyryktobe',         title:'Kuyryktobe Settlement',                 location:'near Kogam' },
    { id:'sauran',             title:'Sauran Fortress',                        location:'Turkestan Region' },
    { id:'munlyk-zarlyk',      title:'Epic “Munlyq–Zarlyq”',                   location:'Turkestan' },
    { id:'yasawi',             title:'Mausoleum of Khoja Ahmed Yasawi',        location:'Turkestan city' },
    { id:'azret-sultan',       title:'Azret Sultan Reserve-Museum',            location:'historic center' },
    { id:'rabia-sultan-begim', title:'Mausoleum of Rabia Sultan Begim',        location:'near Yasawi' },
    { id:'khilvet',            title:'Underground Mosque Khilvet',             location:'Azret Sultan' },
    { id:'esim-khan',          title:'Mausoleum of Esim Khan',                 location:'Azret Sultan' },
    { id:'ethnoaul',           title:'Ethno-village',                          location:'Turkestan city' },
    { id:'juma',               title:'Juma Mosque',                            location:'Turkestan city' },
    { id:'regional-museum',    title:'Regional History Museum',                location:'Turkestan city' },
    { id:'keruen-sarai',       title:'Keruen Sarai',                           location:'new city' },
    { id:'kultobe',            title:'Kultobe Settlement',                     location:'historic center' },
    { id:'yasawi-museum',      title:'Khoja Ahmed Yasawi Museum',              location:'Azret Sultan' },
    { id:'railway',            title:'Railway Station Building',               location:'Turkestan city' },
    { id:'amphitheater',       title:'Amphitheatre',                           location:'Turkestan city' },
    { id:'drama-theater',      title:'Kazakh Music & Drama Theatre',           location:'Turkestan city' },
    { id:'jibek-joly-park',    title:'Jibek Joly Amusement Park',              location:'city center' },
    { id:'flying-theater',     title:'Flying Theatre',                         location:'Turkestan city' },
    { id:'first-president-park', title:'First President Park',                 location:'Turkestan city' },
    { id:'gauhar-ana',         title:'Mausoleum “Gauhar Ana”',                 location:'near the city' },
    { id:'ukasha-ata',         title:'Mausoleum & Well of Ukasha Ata',         location:'near the city' },
    { id:'arystan-bab',        title:'Mausoleum of Arystan Bab',               location:'~150 km from Turkestan' },
    { id:'karatau-reserve',    title:'Karatau Nature Reserve',                 location:'Karatau Mountains' },
    { id:'akmeshit-cave',      title:'Akmeshit Cave',                          location:'~90 km from the city' }
  ];
  const TOTAL = PLACES.length;

  /* ===== Thumbnails (try multiple paths; graceful fallback) ===== */
  const OVERRIDES = {
    yasawi: 'img/0_c280d24e5f3d7fa18e923992968ec42fe96ddde1e7abee1c0daa6b9e6b99320c.png.webp'
  };
  function coverArt(title, a=200, b=320){
    const t=(title||'').replace(/&/g,'&amp;');
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='280' height='180'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop stop-color='hsl(${a},80%,55%)'/><stop offset='1' stop-color='hsl(${b},80%,50%)'/></linearGradient></defs>
      <rect width='100%' height='100%' rx='14' fill='url(#g)'/>
      <text x='50%' y='58%' text-anchor='middle' font-size='20' font-family='Inter,Segoe UI,Arial'
        fill='rgba(255,255,255,.94)' style='paint-order:stroke;stroke:#000;stroke-width:4'>${t}</text>
    </svg>`;
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }
  function resolveImageFor(id){
    const custom = OVERRIDES[id] ? [OVERRIDES[id]] : [];
    const cand = [
      `img/${id}.webp`,`img/${id}.jpg`,`img/${id}.jpeg`,`img/${id}.png`,
      `img/places/${id}.webp`,`img/places/${id}.jpg`,`img/places/${id}.jpeg`,
      `img/places/${id}/cover.webp`,`img/places/${id}/cover.jpg`,`img/places/${id}/cover.jpeg`,`img/places/${id}/cover.png`
    ];
    return [...custom, ...cand];
  }
  function loadThumb(img, title, id){
    const list = resolveImageFor(id); let i=0;
    const fallback = coverArt(title);
    function next(){
      if(i>=list.length){ img.src=fallback; return; }
      const test = new Image(); const src=list[i++];
      test.onload = ()=> img.src=src;
      test.onerror = next;
      test.src = src;
    }
    next();
  }

  /* ===== Visited storage (reads common keys used by your site) ===== */
  function loadVisited() {
    const set = new Set(); const dates = {};
    const keys = ['visited','visitedPlaces','tg.visits','passport_visits','place_visits','passport_log'];
    for (const k of keys){
      try{
        const raw = localStorage.getItem(k); if(!raw) continue;
        if (k==='passport_log'){
          (JSON.parse(raw)||[]).forEach(x=>{ if(x?.id){ set.add(x.id); if(x.date) dates[x.id]=x.date; } });
        }else{
          const v = JSON.parse(raw);
          if (Array.isArray(v)) v.forEach(id=>set.add(id));
          else if (v && typeof v==='object'){
            Object.keys(v).forEach(id=>{
              if (v[id]) set.add(id);
              const val=v[id];
              if (typeof val==='number' || typeof val==='string') dates[id]=val;
              else if (val && val.date) dates[id]=val.date;
            });
          }
        }
      }catch{}
    }
    return {set, dates};
  }

  /* ===== Profile helpers ===== */
  function loadProfile(){ try{return JSON.parse(localStorage.getItem('passport_profile')||'{}');}catch{return{};} }
  function saveProfile(p){ try{localStorage.setItem('passport_profile', JSON.stringify(p));}catch{} }
  function formatDate(d){
    try{ const dt=new Date(typeof d==='number'?d:Number(d)||d);
         return isFinite(dt)?dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}):''; }catch{return'';}
  }
  function levelName(n){ return n>=27?'Master':n>=20?'Gold':n>=12?'Silver':n>=5?'Bronze':'Newcomer'; }

  /* ===== Render ===== */
  const elStamps   = document.getElementById('stamps');
  const elTimeline = document.getElementById('timeline');
  const elVisited  = document.getElementById('visited-badge');
  const elBar      = document.getElementById('pr-bar');
  const elText     = document.getElementById('pr-text');
  const elLevel    = document.getElementById('level');

  function render(){
    const {set:vis, dates} = loadVisited();

    // stamps
    elStamps.innerHTML = '';
    PLACES.forEach(p=>{
      const v = vis.has(p.id);
      const card = document.createElement('article');
      card.className = 'stamp' + (v?' visited':'');
      card.innerHTML = `
        <img class="thumb" loading="lazy" alt="${p.title}">
        <div class="title">${p.title}</div>
        <div class="loc">${p.location}</div>
        <div class="${v?'date':'status'}">${v ? ('Visited: ' + (dates[p.id]?formatDate(dates[p.id]):'')) : '— Not visited yet'}</div>
        <div class="emblem" aria-hidden="true"></div>`;
      elStamps.appendChild(card);
      loadThumb(card.querySelector('.thumb'), p.title, p.id);
    });

    // progress
    const n = vis.size, pct = Math.round(n*100/TOTAL);
    elBar.style.width = pct+'%';
    elText.textContent = `${n} of ${TOTAL} places`;
    elVisited.textContent = `Visited: ${n} / ${TOTAL}`;
    elLevel.textContent = `Level: ${levelName(n)}`;

    // achievements
    document.getElementById('ach-5').classList.toggle('on', n>=5);
    document.getElementById('ach-12').classList.toggle('on', n>=12);
    document.getElementById('ach-20').classList.toggle('on', n>=20);
    document.getElementById('ach-27').classList.toggle('on', n>=27);

    // timeline
    const items = [];
    PLACES.forEach(p=>{
      if (!vis.has(p.id)) return;
      items.push({title:p.title, when: dates[p.id]||0});
    });
    items.sort((a,b)=>(b.when||0)-(a.when||0));
    elTimeline.innerHTML = items.length
      ? items.map(it=>`<div class="tl-item"><strong>${it.title}</strong><div class="muted">${it.when?formatDate(it.when):''}</div></div>`).join('')
      : `<div class="muted">Empty for now — mark any place with the “I was here” button on its page.</div>`;
  }

  /* ===== Controls ===== */
  document.getElementById('btn-print').addEventListener('click', ()=>window.print());

  document.getElementById('btn-export').addEventListener('click', ()=>{
    const data = { profile: loadProfile(), log: JSON.parse(localStorage.getItem('passport_log')||'[]') };
    const url = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
    const a = Object.assign(document.createElement('a'), {href:url, download:'turkestan-passport.json'}); a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btn-import').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{
      const f = inp.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const d = JSON.parse(r.result||'{}');
          if (d.profile) localStorage.setItem('passport_profile', JSON.stringify(d.profile));
          if (Array.isArray(d.log)) localStorage.setItem('passport_log', JSON.stringify(d.log));
          render(); alert('Imported successfully.');
        }catch(e){ alert('Import failed.'); }
      };
      r.readAsText(f);
    };
    inp.click();
  });

  // HARD RESET: wipe all related keys and reload (fixes “Reset” not clearing)
  document.getElementById('btn-reset').addEventListener('click', ()=>{
    if (!confirm('Reset all progress? This will clear visited marks, profile and timeline.')) return;
    try{
      const whitelist = new Set([
        'passport_profile','passport_log','visited','visitedPlaces',
        'tg.visits','passport_visits','place_visits','tg_passport_v1',
        'tg_visited','tg_profile'
      ]);
      whitelist.forEach(k=>{ try{ localStorage.removeItem(k); }catch{} });
      for (let i = localStorage.length - 1; i >= 0; i--){
        const k = localStorage.key(i); if(!k) continue;
        if (/(passport|visited|turkestan|yasawi|tg_)/i.test(k)){
          try{ localStorage.removeItem(k); }catch{}
        }
      }
    }catch{}
    location.reload();
  });

  // Profile bindings
  (function(){
    const p = loadProfile();
    const nameEl = document.getElementById('p-name');
    const clsEl  = document.getElementById('p-class');
    if (p.name) nameEl.value = p.name;
    if (p.class) clsEl.value  = p.class;
    function save(){ saveProfile({name:nameEl.value.trim(), class:clsEl.value.trim()}); }
    nameEl.addEventListener('input', save);
    clsEl .addEventListener('input', save);
  })();

  // Footer year & initial render
  document.getElementById('y').textContent = new Date().getFullYear();
  render();
  </script>
</body>
</html>
