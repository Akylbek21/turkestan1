<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Turkestan Guide ‚Äî Places</title>
  <link rel="stylesheet" href="css/main.css"/>

  <!-- Force default language = EN before i18n loads -->
  <script>try{localStorage.setItem('lang','en');}catch(e){}</script>

  <!-- IMPORTANT: load i18n.js before shared.js -->
  <script defer src="js/i18n.js"></script>
  <script defer src="js/shared.js"></script>
</head>

<!-- Subtle 3D tilt on cards -->
<script>
(()=>{const ok=!window.matchMedia('(prefers-reduced-motion: reduce)').matches;
if(!ok) return;
const max=6; // deg
function tilt(e){
  const c=e.currentTarget, r=c.getBoundingClientRect();
  const x=(e.clientX - (r.left+r.width/2)) / (r.width/2);
  const y=(e.clientY - (r.top+r.height/2)) / (r.height/2);
  c.style.transform=`translateY(-4px) perspective(700px) rotateX(${(-y*max).toFixed(2)}deg) rotateY(${(x*max).toFixed(2)}deg) scale(1.01)`;
}
function reset(e){ e.currentTarget.style.transform=''; }
addEventListener('pointerover',e=>{
  const a=e.target.closest('.card'); if(!a) return;
  a.addEventListener('pointermove',tilt); a.addEventListener('pointerout',reset,{once:true});
},{passive:true});
})();
</script>

<body>
<header>
  <div class="container header-row">
    <h1>Highlights of Turkestan Region</h1>

    <nav class="toolbar" aria-label="Main controls">
      <a id="nav-guide" href="guide.html" class="pill" title="Guide">Guide</a>
      <a id="nav-passport" href="passport.html" class="pill" title="Passport">Passport</a>

      <!-- Language: EN / KK -->
      <div class="pill segmented lang-switch" role="group" aria-label="Language">
        <button class="lang active" data-lang="en" type="button"><span class="flag">üá¨üáß</span><span>EN</span></button>
        <button class="lang" data-lang="kk" type="button"><span class="flag">üá∞üáø</span><span>KK</span></button>
      </div>

      <!-- Counters (i18n.js will update texts) -->
      <span class="pill stat"><span id="count-badge">0 places</span></span>
      <span class="pill stat"><span id="visited-badge">Visited: 0</span></span>
    </nav>
  </div>

  <!-- Search + filter row -->
  <div class="container" style="display:grid;grid-template-columns:1fr 220px;gap:10px">
    <label class="search"><input id="q" placeholder="Search: Yasawi, Otrar, Sauran‚Ä¶"></label>
    <select id="cat" class="select" aria-label="Category">
      <!-- Values stay RU (filter logic depends on that) -->
      <option value="">All categories</option>
      <option value="–ú–∞–≤–∑–æ–ª–µ–π">Mausoleum</option>
      <option value="–ú–µ—á–µ—Ç—å">Mosque</option>
      <option value="–ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è">Archaeology</option>
      <option value="–ú—É–∑–µ–π">Museum</option>
      <option value="–ö—É–ª—å—Ç—É—Ä–∞">Culture</option>
      <option value="–°—Ü–µ–Ω–∞">Stage</option>
      <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">Attractions</option>
      <option value="–ü–∞—Ä–∫">Park</option>
      <option value="–ê—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω">Ride</option>
      <option value="–ü—Ä–∏—Ä–æ–¥–∞">Nature</option>
      <option value="–ü–µ—â–µ—Ä–∞">Cave</option>
      <option value="–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞">Infrastructure</option>
    </select>
  </div>
</header>

<section class="grid" id="grid" aria-live="polite"></section>

<footer>
  <div class="container">
    <div>¬© <span id="y"></span> Turkestan Guide ‚Äî multi-page edition</div>
    <div>HTML ‚Ä¢ CSS ‚Ä¢ JS</div>
  </div>
</footer>

<script>
/* ===== 1) DATA (English titles/locations; categories keep RU values) ===== */
const PLACES = [
  { id:'arys-station',      title:'Arys-1 Railway Station',              location:'Arys city',                 category:'–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', img:'img/arys-station.webp' },
  { id:'otrar',             title:'Otrar Settlement (Otyrartobe)',       location:'Shaulder village',          category:'–ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è',     img:'img/otrar.webp' },
  { id:'kuyryktobe',        title:'Kuyryktobe Settlement',                location:'near Kogam',                category:'–ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è',     img:'img/kuyryktobe.webp' },
  { id:'sauran',            title:'Sauran Fortress',                       location:'Turkestan Region',          category:'–ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è',     img:'img/sauran.webp' },
  { id:'munlyk-zarlyk',     title:'Epic ‚ÄúMunlyq‚ÄìZarlyq‚Äù',                  location:'Turkestan',                 category:'–ö—É–ª—å—Ç—É—Ä–∞' },

  { id:'yasawi',            title:'Mausoleum of Khoja Ahmed Yasawi',       location:'Turkestan city',            category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'azret-sultan',      title:'Azret Sultan Reserve-Museum',           location:'historic center',           category:'–ú—É–∑–µ–π' },
  { id:'rabia-sultan-begim',title:'Mausoleum of Rabia Sultan Begim',       location:'near Yasawi',               category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'khilvet',           title:'Underground Mosque Khilvet',            location:'Azret Sultan',              category:'–ú–µ—á–µ—Ç—å' },
  { id:'esim-khan',         title:'Mausoleum of Esim Khan',                location:'Azret Sultan',              category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'ethnoaul',          title:'Ethno-village',                         location:'Turkestan city',            category:'–ö—É–ª—å—Ç—É—Ä–∞' },
  { id:'juma',              title:'Juma Mosque',                           location:'Turkestan city',            category:'–ú–µ—á–µ—Ç—å' },
  { id:'regional-museum',   title:'Regional History Museum',               location:'Turkestan city',            category:'–ú—É–∑–µ–π' },
  { id:'keruen-sarai',      title:'Keruen Sarai',                          location:'new city',                  category:'–ö—É–ª—å—Ç—É—Ä–∞' },
  { id:'kultobe',           title:'Kultobe Settlement',                    location:'historic center',           category:'–ê—Ä—Ö–µ–æ–ª–æ–≥–∏—è' },
  { id:'yasawi-museum',     title:'Khoja Ahmed Yasawi Museum',             location:'Azret Sultan',              category:'–ú—É–∑–µ–π' },
  { id:'railway',           title:'Railway Station Building',              location:'Turkestan city',            category:'–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞' },
  { id:'amphitheater',      title:'Amphitheatre',                          location:'Turkestan city',            category:'–°—Ü–µ–Ω–∞' },
  { id:'drama-theater',     title:'Kazakh Music & Drama Theatre',          location:'Turkestan city',            category:'–°—Ü–µ–Ω–∞' },
  { id:'jibek-joly-park',   title:'Jibek Joly Amusement Park',             location:'city center',               category:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è' },
  { id:'flying-theater',    title:'Flying Theatre',                        location:'Turkestan city',            category:'–ê—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω' },
  { id:'first-president-park', title:'First President Park',               location:'Turkestan city',            category:'–ü–∞—Ä–∫' },
  { id:'gauhar-ana',        title:'Mausoleum ‚ÄúGauhar Ana‚Äù',                location:'near the city',             category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'ukasha-ata',        title:'Mausoleum & Well of Ukasha Ata',        location:'near the city',             category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'arystan-bab',       title:'Mausoleum of Arystan Bab',              location:'~150 km from Turkestan',    category:'–ú–∞–≤–∑–æ–ª–µ–π' },
  { id:'karatau-reserve',   title:'Karatau Nature Reserve',                location:'Karatau Mountains',         category:'–ü—Ä–∏—Ä–æ–¥–∞' },
  { id:'akmeshit-cave',     title:'Akmeshit Cave',                         location:'~90 km from the city',      category:'–ü–µ—â–µ—Ä–∞' }
];

/* ===== 2) Utilities ===== */
function coverArt(title, a=200, b=320){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop stop-color='hsl(${a},80%,55%)'/><stop offset='1' stop-color='hsl(${b},80%,50%)'/></linearGradient></defs>
    <rect fill='url(#g)' width='1200' height='800'/>
    <text x='50%' y='54%' text-anchor='middle' font-size='70' font-family='Inter,Segoe UI,Arial'
      fill='rgba(255,255,255,.92)' style='paint-order:stroke;stroke:#000;stroke-width:8'>${title.replace(/&/g,'&amp;')}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

const OVERRIDES = {
  'yasawi': 'img/0_c280d24e5f3d7fa18e923992968ec42fe96ddde1e7abee1c0daa6b9e6b99320c.png.webp'
};

function resolveImageFor(id){
  const custom = OVERRIDES[id] ? [OVERRIDES[id]] : [];
  const candidates = [
    `img/${id}.webp`, `img/${id}.jpg`, `img/${id}.jpeg`, `img/${id}.png`,
    `img/places/${id}.webp`, `img/places/${id}.jpg`,
    `img/places/${id}/cover.webp`, `img/places/${id}/cover.jpg`, `img/places/${id}/cover.png`
  ];
  return [...custom, ...candidates];
}
function tryLoadFirst(imgEl, title, id){
  const list = resolveImageFor(id);
  let i = 0;
  const fallback = coverArt(title);
  function tryNext(){
    if(i >= list.length){ imgEl.src = fallback; return; }
    const src = list[i++]; const test = new Image();
    test.onload = ()=>{ imgEl.src = src; };
    test.onerror = tryNext;
    test.src = src;
  }
  tryNext();
}

/* ===== 3) Render ===== */
const grid = document.getElementById('grid');
const q = document.getElementById('q');
const cat = document.getElementById('cat');
document.getElementById('y').textContent = new Date().getFullYear();

function cardNode(p){
  const a = document.createElement('a');
  a.className = 'card'; a.href = 'places/'+p.id+'.html'; a.target = '_blank'; a.rel='noopener';
  a.innerHTML = `
    <img alt="${p.title}" loading="lazy">
    <div class="b">
      <div class="loc">${p.location}</div>
      <h3>${p.title}</h3>
      <div class="loc"><span class="tag" data-ru="${p.category}">${p.category}</span></div>
    </div>`;
  const img = a.querySelector('img');
  tryLoadFirst(img, p.title, p.id);
  return a;
}
function render(list){
  grid.innerHTML = '';
  list.forEach(p => grid.appendChild(cardNode(p)));
  // will be replaced by i18n immediately after
  document.getElementById('count-badge').textContent = list.length + ' places';
  updateVisitedBadge(list.length); // from shared.js, if connected

  // apply translations to fresh cards
  if (window.I18N) I18N.updateIndexUI();
}
function apply(){
  const s = (q.value||'').toLowerCase();
  const c = cat.value;
  render(PLACES.filter(p => (!s || (p.title+' '+p.location).toLowerCase().includes(s)) && (!c || p.category===c)));
}
q.addEventListener('input', ()=>setTimeout(apply,80));
cat.addEventListener('change', apply);
render(PLACES);

/* ===== 4) i18n init ===== */
if (window.I18N){
  I18N.init();
  I18N.updateIndexUI();
  I18N.onChange(()=>{ I18N.updateIndexUI(); });
}
</script>

<!-- Fancy custom capsule select for #cat -->
<script>
(function(){
  const sel = document.getElementById('cat');
  if(!sel) return;

  const wrap = document.createElement('div');
  wrap.className = 'selectx';
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'selectx-btn';
  const label = document.createElement('span');
  label.id = 'cat-label';
  btn.append(label);
  const list = document.createElement('ul');
  list.className = 'selectx-list';
  wrap.append(btn, list);

  sel.style.display = 'none';
  sel.parentNode.insertBefore(wrap, sel.nextSibling);

  function currentLang(){ return (window.I18N && I18N.get && I18N.get()) || 'en'; }
  function mapCats(){ return (window.I18N_MAP_CATS && I18N_MAP_CATS[currentLang()]) || {}; }
  function allText(){
    return (window.I18N && I18N.t) ? I18N.t('filter.all')
          : (currentLang()==='en' ? 'All categories' : '–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä');
  }

  function buildList(){
    list.innerHTML = '';
    const cats = mapCats();
    [...sel.options].forEach(opt=>{
      const li = document.createElement('li');
      const ruVal = opt.value;
      const isAll = !ruVal;
      li.dataset.value = ruVal;
      li.textContent = isAll ? allText() : (cats[ruVal] || ruVal);
      if (opt.selected) li.classList.add('on');
      list.appendChild(li);
    });
    const curOpt = sel.options[sel.selectedIndex];
    label.textContent = curOpt ? (curOpt.value ? (mapCats()[curOpt.value] || curOpt.value) : allText()) : allText();
  }

  btn.addEventListener('click',()=>{ wrap.classList.toggle('open');
    if (wrap.classList.contains('open')){
      list.querySelectorAll('li').forEach(li=>li.classList.toggle('on', li.dataset.value===sel.value));
    }
  });
  document.addEventListener('click',e=>{ if (!wrap.contains(e.target)) wrap.classList.remove('open'); });

  list.addEventListener('click',e=>{
    const li = e.target.closest('li'); if(!li) return;
    const val = li.dataset.value || '';
    sel.value = val;
    label.textContent = li.textContent;
    wrap.classList.remove('open');
    list.querySelectorAll('li').forEach(x=>x.classList.toggle('on', x===li));
    sel.dispatchEvent(new Event('change', {bubbles:true}));
    if (typeof apply === 'function') apply();
  });

  if (window.I18N && I18N.onChange){ I18N.onChange(()=>{ buildList(); }); }
  buildList();
})();
</script>

</body>
</html>
